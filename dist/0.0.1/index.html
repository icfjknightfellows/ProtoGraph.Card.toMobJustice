<!DOCTYPE html>
<html>
  <head>
    <meta charset = "UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mob Justice Card</title>
    <link rel="stylesheet" type="text/css" href="card.min.css">
    <script type="text/javascript">
      // var endpoint, siteId, origin;
      // // Setting variables from environment
      // origin = window.location.origin;
      // if (origin == 'https://s3.ap-south-1.amazonaws.com') {
      //   let bucket_name = window.location.pathname.split('/')['1'];
      //   switch(bucket_name){
      //     case "cdn.protograph":
      //       endpoint = "https://protograph.pykih.com";
      //       siteId = '1';
      //       break;
      //     case "staging.cdn.protograph":
      //       endpoint = "https://protograph-staging.pykih.com";
      //       siteId = '2';
      //       break;
      //     case "dev.cdn.protograph":
      //     default:
      //       endpoint = "https://e6340ed0.ngrok.io";
      //       break;
      //   }
      // } else if (origin === 'https://dkqrqc7q64awx.cloudfront.net') {
      //   endpoint = "https://protograph-staging.pykih.com";
      //   siteId = '2';
      // } else {
      //   endpoint = "https://e6340ed0.ngrok.io";
      // }

      // if(siteId){
      //   var _paq = _paq || [];
      //   /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
      //   _paq.push(['trackPageView']);
      //   _paq.push(['enableLinkTracking']);
      //   (function() {
      //     var u="//protograph.innocraft.cloud/";
      //     _paq.push(['setTrackerUrl', u+'piwik.php']);
      //     _paq.push(['setSiteId', siteId]);
      //     var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
      //     g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
      //   })();
      // }
    </script>
  </head>
  <body>
    <div id="mob-justice-div"></div>
    <script src="https://d2m6lzru8erw1k.cloudfront.net/lib/oasis.min.js"></script>
    <script src = "card.min.js"></script>
    <script type="text/javascript">
      var x = new ProtoGraph.Card.toMobJustice();
      let param = location.search.split('ViewCast_Unique_Identifier=')[1];
      function get(url) {
        return new Promise(function(resolve, reject) {
          var req = new XMLHttpRequest();
          req.open('GET', url);
          req.onload = function() {
            if (req.status == 200) {
              resolve(req.response);
            }
            else {
              reject(Error(req.statusText));
            }
          };
          req.onerror = function() {
            reject(Error("Network Error"));
          };
          req.send();
        });
      }

      var ReceiverConsumer = Oasis.Consumer.extend({
        requests: {
          receive: function(mode) {
            var that = this;
            // get(endpoint+'/api/v1/view_casts/'+param).then(function (response) {
            //   let response_object = JSON.parse(response);
            //   x.init({
            //     selector: document.querySelector('#mob-justice-div'),
            //     data_url: response_object.data_url,
            //     schema_url: response_object.schema_json,
            //     configuration_url: response_object.configuration_url,
            //     configuration_schema_url: 'configuration_schema.json',
            //     onClickCallback: function () {
            //       let h = x.getData().height;
            //       that.send('resize_frame', {width: '100%', height: h})
            //     }
            //   })
            //   renderWithMode(mode);
            // }, function(error) {
            //   console.error("Failed!", error);
            // })
            x.init({
              selector: document.querySelector('#mob-justice-div'),
              data_url: 'sample.json',
              schema_url: 'schema.json',
              configuration_url: "configuration_sample.json",
              configuration_schema_url: 'configuration_schema.json',
              onClickCallback: function () {
                let h = x.getData().height;
                that.send('resize_frame', {width: '100%', height: h})
              }
            })
            renderWithMode(mode);
          }
        },
        events: {
          get_size: function(){
            var that = this;
            var intervalId = setInterval(function(){
              clientRect = x.getData();
              if(clientRect.height){
                var height = clientRect.height,
                  width = clientRect.width;
                console.log(that, "that in get size")
                that.send("resize_frame", {height: height, width: width});
                clearInterval(intervalId);
              }
            }, 10)

          },
          change_mode: function(mode){
            renderWithMode(mode);
            var that = this;
            setTimeout(function(){
              height = x.getData().height;
              that.send("resize_frame", {height: height});
            })
          }
        }
      });
      oasis.connect({
        consumers: {
          receive: ReceiverConsumer
        }
      });

      function renderWithMode(mode) {
        switch(mode){
          case "laptop":
            x.renderLaptop();
            break;
          case "mobile":
            x.renderMobile();
            break;
        }
      }
    </script>
  </body>
</html>